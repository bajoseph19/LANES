{% extends "base.html" %}

{% block title %}Current Cart - Holistic Market{% endblock %}

{% block content %}
<div class="cart-page">
    <div class="section-header">
        <h1 class="section-title">Current Cart</h1>
        {% if current_user.is_authenticated %}
        <span class="text-muted">Welcome {{ current_user.name or current_user.email.split('@')[0] }}!</span>
        {% endif %}
    </div>

    {% if cart_items %}
    <div class="cart-layout">
        <!-- Cart Items -->
        <div class="cart-items-section">
            <div class="cart-items-list">
                {% for item in cart_items %}
                <div class="cart-item">
                    <div class="cart-item-image">&#127859;</div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">{{ item.text }}</div>
                        {% if amazon_data and amazon_data.products[loop.index0] %}
                        <div class="cart-item-product">{{ amazon_data.products[loop.index0].product.name }}</div>
                        {% endif %}
                    </div>
                    {% if amazon_data and amazon_data.products[loop.index0] %}
                    <div class="cart-item-price">${{ amazon_data.products[loop.index0].subtotal|round(2) }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Cart Summary & Delivery -->
        <div class="cart-summary-section">
            <div class="cart-summary">
                <h3>Order Summary</h3>

                {% if amazon_data %}
                <div class="summary-row">
                    <span>Subtotal ({{ amazon_data.item_count }} items)</span>
                    <span>${{ amazon_data.subtotal }}</span>
                </div>
                <div class="summary-row">
                    <span>Estimated Tax</span>
                    <span>${{ amazon_data.tax }}</span>
                </div>
                <div class="summary-row">
                    <span>Delivery</span>
                    <span>{% if amazon_data.delivery_fee == 0 %}FREE{% else %}${{ amazon_data.delivery_fee }}{% endif %}</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span>${{ amazon_data.total }}</span>
                </div>
                {% endif %}

                <!-- Delivery Options -->
                <div class="delivery-section">
                    <h4>Delivery Options</h4>
                    <div class="delivery-options">
                        <label class="delivery-option selected">
                            <input type="radio" name="delivery" value="express" checked>
                            <div>
                                <strong>Express (2-4 hrs)</strong>
                                <span class="text-muted" style="font-size:0.85rem;display:block;">Free over $35</span>
                            </div>
                        </label>
                        <label class="delivery-option">
                            <input type="radio" name="delivery" value="scheduled">
                            <div>
                                <strong>Scheduled</strong>
                                <span class="text-muted" style="font-size:0.85rem;display:block;">Pick a time</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Calendar Section -->
                <div class="calendar-section">
                    <h4 class="text-muted mb-2">Calendar</h4>
                    <div class="calendar-widget">
                        <div class="calendar-header">
                            <button class="calendar-nav">&lt;</button>
                            <span class="calendar-month">February 2026</span>
                            <button class="calendar-nav">&gt;</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-day-header">S</div>
                            <div class="calendar-day-header">M</div>
                            <div class="calendar-day-header">T</div>
                            <div class="calendar-day-header">W</div>
                            <div class="calendar-day-header">T</div>
                            <div class="calendar-day-header">F</div>
                            <div class="calendar-day-header">S</div>

                            <div class="calendar-day today">1</div>
                            <div class="calendar-day selected">2</div>
                            <div class="calendar-day">3</div>
                            <div class="calendar-day">4</div>
                            <div class="calendar-day">5</div>
                            <div class="calendar-day">6</div>
                            <div class="calendar-day">7</div>

                            <div class="calendar-day">8</div>
                            <div class="calendar-day">9</div>
                            <div class="calendar-day">10</div>
                            <div class="calendar-day">11</div>
                            <div class="calendar-day">12</div>
                            <div class="calendar-day">13</div>
                            <div class="calendar-day">14</div>

                            <div class="calendar-day">15</div>
                            <div class="calendar-day">16</div>
                            <div class="calendar-day">17</div>
                            <div class="calendar-day">18</div>
                            <div class="calendar-day">19</div>
                            <div class="calendar-day">20</div>
                            <div class="calendar-day">21</div>

                            <div class="calendar-day">22</div>
                            <div class="calendar-day">23</div>
                            <div class="calendar-day">24</div>
                            <div class="calendar-day">25</div>
                            <div class="calendar-day">26</div>
                            <div class="calendar-day">27</div>
                            <div class="calendar-day">28</div>
                        </div>
                    </div>
                </div>

                <!-- Checkout Button -->
                <a href="{{ url_for('checkout') }}" class="btn btn-amazon btn-block mt-3">
                    Checkout with Amazon Fresh
                </a>

                <p class="text-center text-muted mt-2" style="font-size:0.85rem;">
                    Fulfilled by Amazon Fresh
                </p>
            </div>
        </div>
    </div>

    <!-- Cart Actions -->
    <div class="flex-between mt-3">
        <button onclick="copyToClipboard()" class="btn btn-secondary">
            &#128203; Copy List
        </button>
        <a href="{{ url_for('parse_recipe') }}" class="btn btn-outline">
            + Add More
        </a>
    </div>

    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">&#128722;</div>
        <p>Your cart is empty</p>
        <a href="{{ url_for('parse_recipe') }}" class="btn btn-primary">Add a Recipe Pin</a>
    </div>
    {% endif %}
</div>

<script>
function copyToClipboard() {
    const items = document.querySelectorAll('.cart-item-name');
    const text = Array.from(items).map(item => '- ' + item.textContent.trim()).join('\n');

    navigator.clipboard.writeText(text).then(() => {
        alert('Shopping list copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Shopping list copied to clipboard!');
    });
}

// Calendar day selection
document.querySelectorAll('.calendar-day').forEach(day => {
    day.addEventListener('click', () => {
        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
        day.classList.add('selected');
    });
});

// Delivery option selection
document.querySelectorAll('.delivery-option').forEach(option => {
    option.addEventListener('click', () => {
        document.querySelectorAll('.delivery-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
    });
});
</script>
{% endblock %}
